name: Build Flutter App

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          flutter-version: '3.22.0'

      - name: Get Dependencies
        run: flutter pub get

      - name: Create Android Project
        run: flutter create . --platforms=android

      - name: Force Android SDK Version (Nuclear Option)
        run: |
          # 1. Create local.properties with forced versions
          echo "flutter.minSdkVersion=23" > android/local.properties
          echo "flutter.targetSdkVersion=34" >> android/local.properties
          echo "flutter.compileSdkVersion=34" >> android/local.properties
          
          # 2. Python script to patch build.gradle as backup
          python3 -c "
          import re
          import os
          
          def patch_file(path, pattern, replacement):
              if not os.path.exists(path):
                  print(f'Skipping {path} (not found)')
                  return
              
              with open(path, 'r') as f: content = f.read()
              
              # Check if pattern exists
              if not re.search(pattern, content):
                  print(f'Warning: Pattern {pattern} not found in {path}')
                  print('Content dump (first 500 chars):')
                  print(content[:500])
              else:
                  new_content = re.sub(pattern, replacement, content)
                  with open(path, 'w') as f: f.write(new_content)
                  print(f'Success: Patched {path}')
          
          # Patch 1: Kotlin Version in root build.gradle
          # Matches 'ext.kotlin_version = ...' or injects it
          patch_file('android/build.gradle', 
                    r'ext\.kotlin_version = .*', 
                    \"ext.kotlin_version = '1.9.0'\")

          # Patch 2: minSdkVersion in app/build.gradle
          # Matches 'minSdkVersion ...' (handling spaces)
          patch_file('android/app/build.gradle', 
                    r'\s*minSdkVersion\s+.*', 
                    '\n        minSdkVersion 23')
          "
          
          # 3. Verification
          echo "=== DEBUG: android/app/build.gradle content (minSdk) ==="
          grep "minSdkVersion" android/app/build.gradle || echo "minSdkVersion NOT FOUND"
          echo "=== DEBUG: android/local.properties content ==="
          cat android/local.properties

      - name: Build APK
        run: flutter build apk --release

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: quakesafe-flutter-release
          path: build/app/outputs/flutter-apk/app-release.apk
